let grid=null;let createPostBtn=null;let maxScrollTop=null;let isPullingChunks=!1;let toRemove=null;isPrivate=!0;function requestRemoval(id){toRemove=id;$('#requestRemovalModal').modal('open')}
function tryToRemove(){if(toRemove==null){toast('Tenés que seleccionar un mensaje a eliminar');console.warn('tryToRemove: I was called but "toRemove" was null, there\'s either a severe problem or it\'s just that the user is having fun with the console.')}else{run('messagesManager','tryToRemove',{id:toRemove},()=>{disable($('#requestRemovalModal').find('button'))}).done((response)=>{console.info(response);switch(response.status){case NOT_ALLOWED:toast('No tenés permitido hacer eso, probá recargando la página.');break;case BAD_REQUEST:toast('El servidor no entendió la solicitud, probá recargando la página.');break;case ERROR:toast('Algo salió mal, probá recargando la página.');break;case OK:$('#requestRemovalModal').modal('close');$('.message[data-message="'+toRemove+'"]').fadeOut(()=>{$('.message[data-message="'+toRemove+'"]').remove();toRemove=null;toast('¡Eliminado!');if($('.message:visible').length<1){displayRemovableWarning(NO_MESSAGES_HINT)}else{reloadLayout()}});break}}).always(()=>{enable($('#requestRemovalModal').find('button'))})}}
function getRenderedMessage(id,content,declaredName,created=null,display=!1,image=null,comments=0){auxiliaryContent=content;content.split('http').forEach((match)=>{match.split(' ').forEach((item)=>{if(item.indexOf('://')>-1){auxiliaryContent=auxiliaryContent.replace('http'+item,'<a target="_blank" href="http'+item+'" rel="noreferrer">http'+item+'</a>')}})});return `<div class="col s12 m12 l6 message" `+(display?'':'style="display: none;"')+` data-message="`+id+`">
                <div class="card bg-dark-3 card-box">
                    <button
                        type="button"
                        class="btn-floating halfway-fab mid-card-fab waves-effect waves-light btn-hfab"
                        onclick="requestRemoval(`+id+`);"
                    >
                        <i class="material-icons mid-card-fab-icon">delete</i>
                    </button>`+(image==null?'':`
                    <div class="card-image">
                        <div class="`+(verified?'':'unverified-img')+` message-image" style="background: url('`+image+`');"></div>
                        <img
                            src="`+image+`"
                            style="display: none; width: 0px; height: 0px;"
                            onerror="
                                $(this).parent().hide();

                                reloadLayout();
                            "
                        >
                    </div>`)+`
                    <div class="card-content white-text">
                        <span class="card-title roboto light-3">`+(declaredName==null?'Anónimo':declaredName)+`</span>
                        <p class="lato thin regular word-wrap process-whitespaces overflow-ellipsis message-content light-4">`+(auxiliaryContent.length>MESSAGES.MAX_LENGTH?auxiliaryContent.substr(0,MESSAGES.MAX_LENGTH)+'…':auxiliaryContent)+`
                        </p>
                        <div class="message-spacer"></div>
                        <a
                            class="custom-link regular small"
                            href="view/private/`+id+`"
                        >
                            Ver más
                        </a>
                    </div>
                    <div class="card-action center">
                        <span class="lato regular small">`+dayjs(created==null?new Date():created).format('L LT')+`</span>
                    </div>
                    <ul class="collection with-header bg-dark-7 border-dark-7 hand">
                        <li class="collection-header bg-light-5 bg-dark-7 border-dark-7 no-select" `+(id==null?'':`onclick="openCommentsModal(`+id+`, true);"`)+`>
                            Comentarios (<span class="commentCount">`+comments+`</span>)
                        </li>
                    </ul>
                </div>
            </div>`}
function loadPreloadedRecents(){if(RECENTS.length>0){RECENTS.forEach((message)=>{$('#recentsContainer').find('.row').append(getRenderedMessage(message.id,message.content,message.declaredName,message.created,!0,message.image,message.comments))});reloadLayout()}else{displayRemovableWarning(NO_MESSAGES_HINT)}}
$(document).ready(()=>{createPostBtn=$('#createPostBtn');document.addEventListener('scroll',()=>{if($('.message').length>0&&($(window).scrollTop()>($('.message').last().offset()['top']-((SCROLLTOP_THRESHOLD*(document.documentElement.scrollHeight-document.documentElement.clientHeight))/100))||$(window).scrollTop()==document.documentElement.scrollHeight-document.documentElement.clientHeight)&&!isPullingChunks){run('messagesManager','getRecent',{private:!0,after:getLastMessageId()},()=>{isPullingChunks=!0}).done((response)=>{console.log(response);if(response.result.length>0){let renderedHTML='';response.result.forEach((message)=>{renderedHTML+=getRenderedMessage(message.id,message.content,message.declaredName,message.created,!0,message.image,message.comments)});$('#recentsContainer').find('.row').append(renderedHTML);reloadLayout(renderedHTML);displayIcons();isPullingChunks=!1}else{$(window).off('scroll');isPullingChunks=!0}}).fail((error)=>{isPullingChunks=!1;console.error(error)})}},{passive:!0});$('#messageInput, #declaredName').on('keyup change',function(event){if(event.ctrlKey&&event.key=='Enter'){$('#createPostBtn').click()}else{if($(this).val().trim().length>0){markValid($(this))}else{markInvalid($(this))}}});$('#createPostBtn').on('click',()=>{let messageInput=$('#messageInput');let declaredName=$('#declaredName').val();declaredName=declaredName.length>0?declaredName:null;let messageContent=$('<span>'+messageInput.val().trim()+'</span>').text();if(messageContent.length>0){markValid(messageInput)}else{markInvalid(messageInput);return}
run('messagesManager','postMessage',{'content':messageContent,'declaredName':declaredName},()=>{disable($('#createPostBtn'))}).done((response)=>{console.log(response);switch(response.status){case OK:$('#recentsContainer').find('.row').prepend(getRenderedMessage(response.id,messageContent,declaredName));$('.message').first().fadeIn();$('#messageInput, #declaredName').removeClass('valid').val('');reloadLayout();break;case ERROR:toast('Algo anda mal, probá otra vez.');break}}).always(()=>{setTimeout(()=>{enable($('#createPostBtn'))},INDEX.POST_OK_COOLDOWN)})});if(typeof(navigator.share)!='undefined'){$('#shareBtnHint').show();$('#shareProfileBtn').fadeIn();$('#shareProfileBtn').on('click',()=>{navigator.share({title:'Compartí tu perfil',text:'Dejáme un mensaje: ',url:$('#shareableLink').val()})})}
console.info('document: success fetching critical assets.');loader=()=>{console.info('index/window: success loading assets.');$('#requestRemovalModal').modal()}})